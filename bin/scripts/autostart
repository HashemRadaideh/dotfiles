#!/usr/bin/env bash

function run {
    if ! pgrep -u "$USER" -f "$1" >/dev/null; then
        "$@" &
    fi
}

run dunst

# run mpv --no-video /usr/share/sounds/freedesktop/stereo/service-login.oga

run /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1
run gnome-keyring-daemon --start --components=ssh

run udiskie -s

run playerctld daemon

run showkey

# run wireplumber
# run qjwgraph --minimized

# run flameshot
# run blueman-applet
# run nm-applet --indicator
# run volumeicon

# run /usr/bin/emacs --daemon
run discord
# run steam -silent
# run spotify --minimized
# run teams
# run zoom

if [ "$XDG_SESSION_TYPE" = "x11" ] && [ -n "$DISPLAY" ]; then
    setxkbmap -layout us,ara -option grp:win_space_toggle
    # run setxkbmap -option caps:escape
    xmodmap -e "keycode 135 = Super_R"
    run xset -b

    run picom --config "$DOTFILES/config/picom/picom.conf"

    xset s off
    xset s noblank
    xset -dpms
    xset -b

    run xss-lock lock

    run xidlehook \
        --not-when-fullscreen \
        --not-when-audio \
        --timer 270 \
        'brightnessctl set 35%-; notify-send -u critical -t 10000 -- "LOCKING screen in 30 seconds"' \
        'brightnessctl set 35%+' \
        --timer 30 \
        'brightnessctl set 35%+; lock' \
        '' \
        --timer 300 \
        'systemctl suspend' \
        ''

    run clipcatd
    # run greenclip daemon

    # run plank
    # run polybar
    # run conky -c $HOME/.config/conky/conky.conf

    # screenCount=$(xrandr | rg " connected" | wc -l)

    # if [ $screenCount -gt 1 ]; then
    # run $XDG_DATA_HOME/scripts/screenlayout.sh
    # fi

    # wallpaper="$(find ~/Pictures/wallpapers/ -type f -exec file -- {} + | awk -F':' '/\w+ image/{print $1}' | shuf -n 1)"

    # for (( i = 0; i < $screenCount; i++ )); do
    #   run nitrogen --head="$i" --set-zoom-fill "$wallpaper"
    # done

    run autorotate

    # xrandr --output eDP-1 --mode 1920x1200 --primary && autorandr --save laptop
    # xrandr --output HDMI-1 --primary --mode 2560x1080 --rate 100 --output eDP-1 --mode 1920x1200 --right-of HDMI-1 && autorandr --save desktop
    # xrandr --output HDMI-1 --primary --mode 2560x1080 --rate 100 --output eDP-1 --mode 1920x1200 --rotate right --right-of HDMI-1 && autorandr --save verical-right
    run autorandr -c

    run redshift-gtk -l manual:"$(while ! ping -c 1 1.1.1.1 >/dev/null 2>&1; do sleep 1; done && curl -s "https://location.services.mozilla.com/v1/geolocate?key=geoclue" | jq -r '"\(.location.lat):\(.location.lng)"')"
else
    wallpaper="$(find ~/Pictures/wallpapers/ -type f -exec file -- {} + | awk -F':' '/\w+ image/{print $1}' | shuf -n 1)"

    run swww init && swww img \
        "$wallpaper" \
        --transition-step 255

    run waybar

    # run mako

    run wl-paste --type text --watch cliphist store
    # run wl-paste --type image --watch cliphist store
fi
